<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Athlete Score Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .input-group { background: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); margin-bottom: 1.5rem; }
        .result-row { display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #f3f4f6; }
        .result-row:last-child { border-bottom: none; }
        .multiplier { color: #6b7280; font-size: 0.875rem; }
    </style>
</head>
<body class="p-4 md:p-8">

<div class="max-w-3xl mx-auto">
    <header class="mb-8 text-center">
        <h1 class="text-3xl font-bold text-gray-800">Athlete Funding Score Calculator</h1>
        <p class="text-gray-500 mt-2">Calculate your ranking score based on results, budget, and aim.</p>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        
        <!-- LEFT COLUMN: INPUTS -->
        <div class="md:col-span-2">
            
            <!-- 1. COMPETITION RESULTS -->
            <div class="input-group">
                <h2 class="text-lg font-bold text-blue-700 mb-4 border-b pb-2">1. Top 3 Results</h2>
                <div class="space-y-4" id="resultsContainer">
                    <!-- Rows generated by JS -->
                </div>
            </div>

            <!-- 2. BUDGET -->
            <div class="input-group">
                <h2 class="text-lg font-bold text-purple-700 mb-4 border-b pb-2">2. Budget Request</h2>
                <label class="block text-sm font-medium text-gray-700 mb-2">Requested Share of Total Budget (%)</label>
                <div class="flex items-center gap-4">
                    <input type="range" id="budgetRange" min="0.1" max="2.0" step="0.1" value="0.8" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    <span id="budgetValue" class="font-bold text-gray-800 w-16 text-right">0.8%</span>
                </div>
                <p class="text-xs text-gray-500 mt-2">Requests > 0.5% incur a penalty score reduction.</p>
            </div>

            <!-- 3. AIM & RENEWAL -->
            <div class="input-group">
                <h2 class="text-lg font-bold text-green-700 mb-4 border-b pb-2">3. Aim & History</h2>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Current Aim (Next 2 Years)</label>
                    <select id="currentAim" class="w-full border border-gray-300 rounded-md p-2 bg-white focus:ring-2 focus:ring-green-500 outline-none">
                        <option value="1.000">Tier 1: L1 Medal (x 1.000)</option>
                        <option value="0.975">Tier 2: L1 Final (x 0.975)</option>
                        <option value="0.950">Tier 3: L2 Medal (x 0.950)</option>
                        <option value="0.925">Tier 4: L2 Final (x 0.925)</option>
                        <option value="0.900" selected>Tier 5: L1 Top 16 (x 0.900)</option>
                    </select>
                </div>

                <div class="flex items-center mb-4">
                    <input type="checkbox" id="isRenewal" class="w-4 h-4 text-green-600 border-gray-300 rounded focus:ring-green-500">
                    <label for="isRenewal" class="ml-2 block text-sm text-gray-900 font-medium">Is this a renewal application?</label>
                </div>

                <div id="renewalSection" class="hidden bg-red-50 p-4 rounded-md border border-red-100 space-y-4">
                    <h3 class="text-sm font-bold text-red-800">Previous Cycle Performance</h3>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">What did you promise last time?</label>
                        <select id="prevAim" class="w-full text-sm border border-gray-300 rounded p-1">
                            <option value="1.000">Tier 1: L1 Medal</option>
                            <option value="0.975">Tier 2: L1 Final</option>
                            <option value="0.950">Tier 3: L2 Medal</option>
                            <option value="0.925">Tier 4: L2 Final</option>
                            <option value="0.900" selected>Tier 5: L1 Top 16</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">What did you actually achieve?</label>
                        <select id="realizedResult" class="w-full text-sm border border-gray-300 rounded p-1">
                            <option value="1.000">Tier 1: L1 Medal</option>
                            <option value="0.975">Tier 2: L1 Final</option>
                            <option value="0.950">Tier 3: L2 Medal</option>
                            <option value="0.925">Tier 4: L2 Final</option>
                            <option value="0.900" selected>Tier 5: L1 Top 16</option>
                            <option value="0.875">Floor: L2 Top 16 (Min)</option>
                            <option value="0.000">Failed / Not Qualified</option>
                        </select>
                    </div>
                    <p class="text-xs text-red-600 italic mt-2" id="penaltyMsg">Calculating...</p>
                </div>
            </div>

        </div>

        <!-- RIGHT COLUMN: SCORECARD -->
        <div class="md:col-span-1">
            <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-600 sticky top-6">
                <h2 class="text-xl font-bold text-gray-800 mb-6">Scorecard</h2>
                
                <div class="space-y-4">
                    <div>
                        <p class="text-xs text-gray-500 uppercase font-bold tracking-wide">Base Points</p>
                        <div class="flex justify-between items-end">
                            <span class="text-2xl font-bold text-gray-800" id="dispBasePoints">0.0</span>
                            <span class="text-xs text-gray-400 mb-1">max ~117</span>
                        </div>
                    </div>

                    <div class="border-t pt-2">
                        <div class="result-row">
                            <span class="text-sm text-gray-600">Budget Scaler</span>
                            <span class="font-mono font-bold text-purple-600" id="dispBudgetScale">x 1.00</span>
                        </div>
                        <div class="result-row">
                            <span class="text-sm text-gray-600">Aim Scaler</span>
                            <span class="font-mono font-bold text-green-600" id="dispAimScale">x 0.90</span>
                        </div>
                        <div class="result-row">
                            <span class="text-sm text-gray-600">Penalty Factor</span>
                            <span class="font-mono font-bold text-red-500" id="dispPenaltyScale">x 1.00</span>
                        </div>
                    </div>

                    <div class="bg-gray-100 p-4 rounded-lg text-center mt-4">
                        <p class="text-xs text-gray-500 uppercase mb-1">Final Score</p>
                        <span class="text-4xl font-extrabold text-blue-700" id="dispFinalScore">0.00</span>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    // --- CONSTANTS ---
    // Points: 1st=26, 2nd=21, 3rd=16, 4-8=8, 9-16=4
    const PLACEMENTS = [
        { val: 0, label: "None / >16th" },
        { val: 26, label: "1st Place (26p)" },
        { val: 21, label: "2nd Place (21p)" },
        { val: 16, label: "3rd Place (16p)" },
        { val: 8, label: "4th-8th (8p)" },
        { val: 4, label: "9th-16th (4p)" }
    ];

    const LEVELS = [
        { val: 1.5, label: "Level 1 (OLY/MM)" },
        { val: 1.0, label: "Level 2 (EC/WC)" }
    ];

    const SEASONS = [
        { val: 1.0, label: "Current Season" },
        { val: 0.75, label: "Previous Season" }
    ];

    // --- INIT ---
    function init() {
        const container = document.getElementById('resultsContainer');
        
        for (let i = 1; i <= 3; i++) {
            const div = document.createElement('div');
            div.className = "grid grid-cols-1 sm:grid-cols-3 gap-2 bg-gray-50 p-2 rounded border border-gray-200";
            div.innerHTML = `
                <select class="res-input text-sm border rounded p-1 w-full" onchange="calculate()">
                    ${PLACEMENTS.map(p => `<option value="${p.val}">${p.label}</option>`).join('')}
                </select>
                <select class="res-input text-sm border rounded p-1 w-full" onchange="calculate()">
                    ${LEVELS.map(l => `<option value="${l.val}">${l.label}</option>`).join('')}
                </select>
                <select class="res-input text-sm border rounded p-1 w-full" onchange="calculate()">
                    ${SEASONS.map(s => `<option value="${s.val}">${s.label}</option>`).join('')}
                </select>
            `;
            container.appendChild(div);
        }

        // Event Listeners
        document.getElementById('budgetRange').addEventListener('input', (e) => {
            document.getElementById('budgetValue').innerText = parseFloat(e.target.value).toFixed(1) + '%';
            calculate();
        });
        document.getElementById('currentAim').addEventListener('change', calculate);
        document.getElementById('isRenewal').addEventListener('change', (e) => {
            const section = document.getElementById('renewalSection');
            if (e.target.checked) section.classList.remove('hidden');
            else section.classList.add('hidden');
            calculate();
        });
        document.getElementById('prevAim').addEventListener('change', calculate);
        document.getElementById('realizedResult').addEventListener('change', calculate);

        calculate();
    }

    // --- CALCULATION LOGIC ---
    function calculate() {
        // 1. Calculate Base Points
        const inputs = document.querySelectorAll('#resultsContainer > div');
        let totalBase = 0;

        inputs.forEach(row => {
            const selects = row.querySelectorAll('select');
            const pts = parseInt(selects[0].value);
            const lvl = parseFloat(selects[1].value);
            const time = parseFloat(selects[2].value);
            totalBase += (pts * lvl * time);
        });

        // 2. Budget Scaling
        const budgetPct = parseFloat(document.getElementById('budgetRange').value);
        let budgetScale = 1.0;
        if (budgetPct > 0.5) {
            budgetScale = 1.1 - (0.2 * budgetPct);
            // Floating point correction
            budgetScale = Math.round(budgetScale * 1000) / 1000;
        }
        // Cap at 1.0 if logic somehow exceeds (though formula max is 1.0 at 0.5%)
        if (budgetScale > 1.0) budgetScale = 1.0;

        // 3. Aim Scaling (Current)
        const aimScale = parseFloat(document.getElementById('currentAim').value);

        // 4. Penalty Logic
        let penaltyScale = 1.0;
        const isRenewal = document.getElementById('isRenewal').checked;
        const penaltyMsg = document.getElementById('penaltyMsg');
        
        if (isRenewal) {
            const prev = parseFloat(document.getElementById('prevAim').value);
            const realized = parseFloat(document.getElementById('realizedResult').value);
            
            if (realized === 0.0) {
                // Special case: Total failure / Did not qualify
                // Assuming "Floor" (0.875) for math, or stricter?
                // Using 0.875 as base for calculation if not explicit
                // Let's use the logic: Penalty = (Aim - 0.75) * 1.5 or similar? 
                // Based on previous conv: Floor is 0.875. If Result=0, huge penalty.
                // Let's assume realized 0 means they fell below Floor. Use 0.875 as reference but maybe bigger gap?
                // For simplicity here: treat 0.0 as 0.875 for the 'tier value' but maybe the gap is huge.
                // Actually, let's treat "Failed" as 0.875 val for the diff calculation as defined in sim.
                const floorVal = 0.875;
                const effectiveRealized = realized === 0 ? floorVal : realized;
                
                if (prev > effectiveRealized) {
                    const diff = prev - effectiveRealized;
                    const penalty = diff * 1.5;
                    penaltyScale = 1.0 - penalty;
                    penaltyMsg.innerText = `Missed aim by ${(diff).toFixed(3)}. Penalty: -${(penalty*100).toFixed(1)}%`;
                } else {
                    penaltyMsg.innerText = "Aim met or exceeded. No penalty.";
                    penaltyMsg.className = "text-xs text-green-600 italic mt-2";
                }
            } else if (prev > realized) {
                const diff = prev - realized;
                const penalty = diff * 1.5;
                penaltyScale = 1.0 - penalty;
                penaltyMsg.innerText = `Missed aim by ${diff.toFixed(3)}. Penalty: -${(penalty*100).toFixed(1)}%`;
                penaltyMsg.className = "text-xs text-red-600 italic mt-2";
            } else {
                penaltyMsg.innerText = "Aim met or exceeded. No penalty.";
                penaltyMsg.className = "text-xs text-green-600 italic mt-2";
            }
        }

        // Final Calc
        let finalScore = totalBase * budgetScale * aimScale * penaltyScale;
        finalScore = Math.max(0, finalScore);

        // Update UI
        document.getElementById('dispBasePoints').innerText = totalBase.toFixed(1);
        document.getElementById('dispBudgetScale').innerText = `x ${budgetScale.toFixed(2)}`;
        document.getElementById('dispAimScale').innerText = `x ${aimScale.toFixed(3)}`;
        document.getElementById('dispPenaltyScale').innerText = `x ${penaltyScale.toFixed(2)}`;
        document.getElementById('dispFinalScore').innerText = finalScore.toFixed(2);
    }

    init();
</script>

</body>
</html>