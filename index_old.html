<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elite Sport Funding Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .slider-thumb::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 1rem; height: 1rem; background: #3b82f6; cursor: pointer; border-radius: 50%;
        }
    </style>
</head>
<body class="p-6">

<div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-4 gap-6">
    
    <!-- LEFT PANEL: CONTROLS -->
    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-sm h-fit space-y-6">
        <h1 class="text-xl font-bold text-gray-800 border-b pb-2">Simulation Config</h1>
        
        <!-- Population Settings -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Total Applicants</label>
            <input type="number" id="numAthletes" value="180" class="w-full border rounded p-2 text-gray-700 focus:ring-2 focus:ring-blue-500 outline-none">
            <p class="text-xs text-gray-500 mt-1">Rec: 100 - 300</p>
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">MC Iterations</label>
            <input type="number" id="numIterations" value="1000" min="100" max="50000" step="100" class="w-full border rounded p-2 text-gray-700 focus:ring-2 focus:ring-blue-500 outline-none">
            <p class="text-xs text-gray-500 mt-1">Higher = more accuracy, slower.</p>
        </div>

        <div class="pt-4 border-t">
            <div class="flex justify-between">
                <label class="text-sm font-medium text-gray-700">Gambler %</label>
                <span id="valGambler" class="text-sm text-blue-600 font-bold">20%</span>
            </div>
            <input type="range" id="pctGambler" min="0" max="100" value="20" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider-thumb">
            <p class="text-xs text-gray-500 mt-1">Expensive, High Aim (Tier 1)</p>
        </div>

        <div>
            <div class="flex justify-between">
                <label class="text-sm font-medium text-gray-700">Honest %</label>
                <span id="valHonest" class="text-sm text-green-600 font-bold">60%</span>
            </div>
            <input type="range" id="pctHonest" min="0" max="100" value="60" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider-thumb">
            <p class="text-xs text-gray-500 mt-1">Moderate, Realistic Aim</p>
        </div>

        <div class="p-3 bg-gray-50 rounded border border-gray-200">
            <div class="flex justify-between">
                <span class="text-sm font-medium text-gray-600">Conservative %</span>
                <span id="valConservative" class="text-sm text-gray-800 font-bold">20%</span>
            </div>
            <p class="text-xs text-gray-400 mt-1">Calculated (Remainder)</p>
        </div>

        <!-- System Logic -->
        <div class="pt-4 border-t">
            <label class="block text-sm font-medium text-gray-700 mb-1">Penalty Multiplier</label>
            <input type="number" id="penaltyMult" value="1.5" step="0.1" class="w-full border rounded p-2 text-gray-700">
            <p class="text-xs text-gray-500 mt-1">1.5x means paying back 150% of the gain.</p>
        </div>

        <button onclick="runSimulation()" id="runBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow transition transform active:scale-95">
            Run Simulation
        </button>
        <p id="statusMsg" class="text-center text-xs text-gray-500 h-4"></p>
    </div>

    <!-- RIGHT PANEL: DASHBOARD -->
    <div class="lg:col-span-3 space-y-6">
        
        <!-- TOP CARDS: SYSTEM SUMMARY -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Cycle 1 Card -->
            <div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-blue-500 relative overflow-hidden">
                <div class="flex justify-between items-start mb-2">
                    <h3 class="text-gray-500 text-xs font-uppercase font-bold tracking-wider">CYCLE 1 (ENTRY)</h3>
                    <div id="c1_budget_badge" class="px-2 py-1 text-xs font-bold rounded bg-gray-100 text-gray-600">
                        --% Budget
                    </div>
                </div>
                
                <div class="flex justify-between items-baseline mt-2">
                    <div>
                        <span class="text-3xl font-bold text-gray-800" id="c1_funded">--</span>
                        <span class="text-sm text-gray-500">athletes funded</span>
                    </div>
                    <div class="text-right">
                        <span class="block text-xl font-semibold text-gray-700" id="c1_cutoff">-- pts</span>
                        <span class="text-xs text-gray-400" id="c1_context">--</span>
                    </div>
                </div>
                <div class="mt-2 text-xs text-gray-400 flex justify-between">
                    <span>Range: <span id="c1_range">--</span></span>
                </div>
            </div>

            <!-- Cycle 2 Card -->
            <div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-purple-500 relative overflow-hidden">
                <div class="flex justify-between items-start mb-2">
                    <h3 class="text-gray-500 text-xs font-uppercase font-bold tracking-wider">CYCLE 2 (RENEWAL)</h3>
                    <div id="c2_budget_badge" class="px-2 py-1 text-xs font-bold rounded bg-gray-100 text-gray-600">
                        --% Budget
                    </div>
                </div>

                <div class="flex justify-between items-baseline mt-2">
                    <div>
                        <span class="text-3xl font-bold text-gray-800" id="c2_funded">--</span>
                        <span class="text-sm text-gray-500">athletes funded</span>
                    </div>
                    <div class="text-right">
                        <span class="block text-xl font-semibold text-gray-700" id="c2_cutoff">-- pts</span>
                        <span class="text-xs text-gray-400" id="c2_context">--</span>
                    </div>
                </div>
                <div class="mt-2 text-xs text-gray-400 flex justify-between">
                    <span>Range: <span id="c2_range">--</span></span>
                </div>
            </div>
        </div>

        <!-- CHART AREA -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-white p-4 rounded-xl shadow-sm">
                <h4 class="text-sm font-bold text-gray-700 mb-4">Funding Counts by Profile</h4>
                <canvas id="fundingChart" height="200"></canvas>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm">
                <h4 class="text-sm font-bold text-gray-700 mb-4">Survival Rate & Avg Penalty</h4>
                <canvas id="survivalChart" height="200"></canvas>
            </div>
        </div>

        <!-- TABLES -->
        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-100 bg-gray-50">
                <h3 class="font-bold text-gray-800">Profile Performance Averages</h3>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 border-b">
                        <tr>
                            <th class="px-6 py-3">Profile</th>
                            <th class="px-6 py-3 text-right">Population</th>
                            <th class="px-6 py-3 text-right">Funded C1</th>
                            <th class="px-6 py-3 text-right">Funded C2</th>
                            <th class="px-6 py-3 text-right">Dropped</th>
                            <th class="px-6 py-3 text-right">Survival %</th>
                            <th class="px-6 py-3 text-right">Avg Penalty</th>
                        </tr>
                    </thead>
                    <tbody id="profileTableBody" class="text-gray-600">
                        <!-- Rows generated by JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-100 bg-gray-50">
                <h3 class="font-bold text-gray-800">Quality Benchmark (Survivors vs Dropouts)</h3>
                <p class="text-xs text-gray-500">Lower Tier number is better (1 = Gold, 6 = Floor). Shows required quality to survive.</p>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 border-b">
                        <tr>
                            <th class="px-6 py-3">Profile</th>
                            <th class="px-6 py-3 text-right">Avg Tier (Survivors)</th>
                            <th class="px-6 py-3 text-right">Avg Skill (Survivors)</th>
                            <th class="px-6 py-3 text-right">Avg Tier (Dropouts)</th>
                            <th class="px-6 py-3 text-right">Avg Skill (Dropouts)</th>
                        </tr>
                    </thead>
                    <tbody id="qualityTableBody" class="text-gray-600">
                        <!-- Rows generated by JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- SCORING LOGIC EXPLANATION -->
        <div class="mt-8 bg-white p-8 rounded-xl shadow-sm space-y-6 text-gray-800">
            <h2 class="text-2xl font-bold text-gray-900 border-b pb-2">System Logic & Scoring Rules</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                
                <!-- COLUMN 1: POINTS -->
                <div>
                    <h3 class="font-bold text-lg mb-3 text-blue-700">1. Base Points Calculation</h3>
                    <p class="text-sm mb-3">Athletes submit 3 best results. Points are calculated as: <br><code>Score = PlacePoints × LevelMult × TimeMult</code></p>
                    
                    <table class="w-full text-sm border border-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="p-2 border">Placement</th>
                                <th class="p-2 border">Points</th>
                                <th class="p-2 border">Example (L1)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td class="p-2 border">1st</td><td class="p-2 border">26</td><td class="p-2 border">39.0</td></tr>
                            <tr><td class="p-2 border">2nd</td><td class="p-2 border">21</td><td class="p-2 border">31.5</td></tr>
                            <tr><td class="p-2 border">3rd</td><td class="p-2 border">16</td><td class="p-2 border">24.0</td></tr>
                            <tr><td class="p-2 border">4th-8th</td><td class="p-2 border">8</td><td class="p-2 border">12.0</td></tr>
                            <tr><td class="p-2 border">9th-16th</td><td class="p-2 border">4</td><td class="p-2 border">6.0</td></tr>
                        </tbody>
                    </table>
                    
                    <div class="mt-4 text-sm">
                        <p><strong>Multipliers:</strong></p>
                        <ul class="list-disc list-inside ml-2">
                            <li><strong>Level 1 (MM/OLY):</strong> x1.5</li>
                            <li><strong>Level 2 (EC/WC):</strong> x1.0</li>
                            <li><strong>Past Season:</strong> x0.75</li>
                            <li><strong>Current Season:</strong> x1.00</li>
                        </ul>
                    </div>
                </div>

                <!-- COLUMN 2: SCALING & PENALTY -->
                <div>
                    <h3 class="font-bold text-lg mb-3 text-purple-700">2. Scaling & Penalties</h3>
                    
                    <h4 class="font-bold text-sm mt-2">A. Budget Scaling (Cost Efficiency)</h4>
                    <p class="text-sm mb-2 text-gray-600">Rich requests get a score penalty.</p>
                    <ul class="list-disc list-inside text-sm bg-gray-50 p-2 rounded">
                        <li><strong>≤ 0.5% Request:</strong> No Penalty (x1.0)</li>
                        <li><strong>> 0.5% Request:</strong> <code>1.1 - (0.2 × Req%)</code></li>
                        <li><em>Ex: 2.0% Request = x0.70 Multiplier</em></li>
                    </ul>

                    <h4 class="font-bold text-sm mt-4">B. Aim Scaling (Risk/Reward)</h4>
                    <p class="text-sm mb-2 text-gray-600">Higher aim gives a multiplier now, but risks a penalty later.</p>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div class="bg-gray-50 p-2 rounded">
                            <strong>Multipliers (Now):</strong><br>
                            Tier 1 (Medal): 1.000<br>
                            Tier 2 (L1 Final): 0.975<br>
                            Tier 3 (L2 Medal): 0.950<br>
                            Tier 4 (L2 Final): 0.925<br>
                            Tier 5 (L1 T16): 0.900
                        </div>
                        <div class="bg-red-50 p-2 rounded border border-red-100">
                            <strong>Penalty (Next Cycle):</strong><br>
                            If you miss your aim:<br>
                            <code>Penalty = (Aim - Result) × 1.5</code><br>
                            <em>Ex: Aim Tier 1 (1.0) -> Result Tier 5 (0.9).<br>Diff 0.1 × 1.5 = <strong>15% Cut</strong>.</em>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-4 pt-4 border-t text-sm text-gray-500">
                <strong>Simulation Logic:</strong> The Monte Carlo engine creates random athletes using a Beta distribution (skewed towards lower skill). It simulates two full funding cycles including "Interim" competition results to determine if aims were met. The "Rank" is determined by <code>Final Score = BasePts × BudgetScale × AimScale × (1 - Penalty)</code>. Funding stops when 100% of the budget is exhausted.
            </div>
        </div>

    </div>
</div>

<script>
    // --- CONSTANTS ---
    const POINTS_MAP = {
        '1': 26, '2': 21, '3': 16,
        '4-8': 8, '9-16': 4, 'None': 0
    };
    
    const TIERS = {
        1: {name: 'L1 Medal',   val: 1.000},
        2: {name: 'L1 Final',   val: 0.975},
        3: {name: 'L2 Medal',   val: 0.950},
        4: {name: 'L2 Final',   val: 0.925},
        5: {name: 'L1 Top16',   val: 0.900},
        6: {name: 'Floor/Fail', val: 0.875}
    };

    // --- MATH HELPERS ---
    
    // Normal distribution using Box-Muller transform
    function randomNormal(mean, variance) {
        let u = 0, v = 0;
        while(u === 0) u = Math.random();
        while(v === 0) v = Math.random();
        let num = Math.sqrt( -2.0 * Math.log( u ) ) * Math.cos( 2.0 * Math.PI * v );
        return mean + num * variance; 
    }

    // Beta Distribution Generator
    function randomGammaInt(k) {
        let sum = 0.0;
        for(let i=0; i<k; i++) {
            sum += -Math.log(Math.random());
        }
        return sum;
    }

    function randomBeta(alpha, beta) {
        const x = randomGammaInt(alpha);
        const y = randomGammaInt(beta);
        return x / (x + y);
    }

    // --- ATHLETE LOGIC ---

    class Athlete {
        constructor(id, settings) {
            this.id = id;
            this.skill = randomBeta(2, 5);
            
            // Profile Assignment
            const r = Math.random();
            const pGambler = settings.pctGambler / 100;
            const pHonest = settings.pctHonest / 100;
            
            if (r < pGambler) {
                this.profile = 'Gambler';
                this.budget_req = 1.5 + (Math.random() * 0.5); // 1.5 - 2.0
            } else if (r < pGambler + pHonest) {
                this.profile = 'Honest';
                if (this.skill > 0.8) {
                    this.budget_req = 1.2 + (Math.random() * 0.8); // 1.2 - 2.0 (Stars)
                } else {
                    this.budget_req = 0.8 + (Math.random() * 0.7); // 0.8 - 1.5 (Masses)
                }
            } else {
                this.profile = 'Conservative';
                this.budget_req = 0.8 + (Math.random() * 0.7); // 0.8 - 1.5
            }

            this.history = [];
            this.current_penalty = 0.0;
            this.aim_history = [];
            this.score_history = [];
            this.cycle_1_performance_tier = 6;
        }

        get_result(variance = 0.15) {
            const perf = randomNormal(this.skill, variance);
            
            if (perf > 0.95) return {pos:'1', lvl:1.5, tier:1};
            if (perf > 0.90) return {pos:'2', lvl:1.5, tier:1};
            if (perf > 0.85) return {pos:'3', lvl:1.5, tier:1};
            if (perf > 0.75) return {pos:'4-8', lvl:1.5, tier:2};
            if (perf > 0.65) return {pos:'3', lvl:1.0, tier:3};
            if (perf > 0.55) return {pos:'4-8', lvl:1.0, tier:4};
            if (perf > 0.45) return {pos:'9-16', lvl:1.5, tier:5};
            if (perf > 0.15) return {pos:'9-16', lvl:1.0, tier:6};
            
            return {pos:'None', lvl:0, tier:7};
        }

        simulate_season() {
            let season_results = [];
            for(let i=0; i<3; i++) {
                let res = this.get_result();
                res.time = 1.0; 
                season_results.push(res);
            }
            return season_results;
        }

        run_cycle(cycle_num, settings) {
            // Simulate Results (Past + Current) - 6 attempts total
            let all_results = [];
            for(let i=0; i<6; i++) {
                let res = this.get_result();
                res.time = (i < 3) ? 0.75 : 1.0; // 3 past, 3 current
                all_results.push(res);
            }

            // Calc Base Points
            let scores = all_results.map(r => (POINTS_MAP[r.pos] || 0) * r.lvl * r.time);
            scores.sort((a,b) => b - a);
            this.base_points = scores.slice(0,3).reduce((a,b) => a+b, 0);

            // Determine True Tier (Best of Current 3)
            let current_results = all_results.slice(3,6);
            let valid_tiers = current_results.filter(r => r.tier < 7).map(r => r.tier);
            let best_tier_achieved = valid_tiers.length > 0 ? Math.min(...valid_tiers) : 6;

            // Set Aim
            if (this.profile === 'Gambler') this.aim_tier = 1;
            else if (this.profile === 'Conservative') this.aim_tier = Math.min(best_tier_achieved + 1, 6);
            else this.aim_tier = best_tier_achieved; // Honest

            this.aim_val = TIERS[this.aim_tier] ? TIERS[this.aim_tier].val : TIERS[6].val;

            // Budget Scaling
            let req = this.budget_req;
            this.budget_scaler = (req <= 0.5) ? 1.0 : (1.1 - (0.2 * req));

            // Penalty Logic
            let penalty_factor = 1.0;
            if (cycle_num === 2) {
                let realized = this.cycle_1_performance_tier;
                let prev_aim_val = this.aim_history[0].val;
                let realized_val = TIERS[realized] ? TIERS[realized].val : TIERS[6].val;

                if (prev_aim_val > realized_val) {
                    let diff = prev_aim_val - realized_val;
                    let penalty = diff * settings.penaltyMult;
                    penalty_factor = 1.0 - penalty;
                    this.current_penalty = penalty_factor;
                } else {
                    this.current_penalty = 1.0;
                }
            }

            let final_score = this.base_points * this.budget_scaler * this.aim_val * penalty_factor;
            final_score = Math.max(0, final_score);

            this.score_history.push(final_score);
            this.aim_history.push({tier: this.aim_tier, val: this.aim_val});

            return final_score;
        }
    }

    // --- MAIN SIMULATION LOOP ---

    function runSimulation() {
        const btn = document.getElementById('runBtn');
        const status = document.getElementById('statusMsg');
        const numIter = parseInt(document.getElementById('numIterations').value) || 1000;
        
        btn.disabled = true;
        btn.classList.add('opacity-50');
        status.innerText = `Running ${numIter.toLocaleString()} Iterations...`;

        // Delay to allow UI to update
        setTimeout(() => {
            const start = performance.now();
            executeMonteCarlo(numIter);
            const end = performance.now();
            const duration = (end - start).toFixed(0);
            
            btn.disabled = false;
            btn.classList.remove('opacity-50');
            status.innerText = `Completed ${numIter.toLocaleString()} runs in ${duration}ms`;
        }, 50);
    }

    function executeMonteCarlo(iterations) {
        // Read Settings
        const settings = {
            numAthletes: parseInt(document.getElementById('numAthletes').value),
            pctGambler: parseInt(document.getElementById('pctGambler').value),
            pctHonest: parseInt(document.getElementById('pctHonest').value),
            penaltyMult: parseFloat(document.getElementById('penaltyMult').value)
        };
        const totalBudget = 100.0;

        // FIXED: Initialized 'survived' property to 0
        let stats = {
            'Gambler': { pop: 0, c1: 0, c2: 0, drop: 0, penaltySum: 0, survSkill: 0, survTier: 0, dropSkill: 0, dropTier: 0, survCount: 0, dropCount: 0, survived: 0 },
            'Honest': { pop: 0, c1: 0, c2: 0, drop: 0, penaltySum: 0, survSkill: 0, survTier: 0, dropSkill: 0, dropTier: 0, survCount: 0, dropCount: 0, survived: 0 },
            'Conservative': { pop: 0, c1: 0, c2: 0, drop: 0, penaltySum: 0, survSkill: 0, survTier: 0, dropSkill: 0, dropTier: 0, survCount: 0, dropCount: 0, survived: 0 }
        };

        let sysC1 = { sum: 0, min: 9999, max: 0, sumCutoff: 0, sumSpent: 0 };
        let sysC2 = { sum: 0, min: 9999, max: 0, sumCutoff: 0, sumSpent: 0 };

        for(let i=0; i<iterations; i++) {
            let athletes = [];
            for(let j=0; j<settings.numAthletes; j++) {
                athletes.push(new Athlete(j, settings));
            }

            // --- C1 ---
            let c1_data = athletes.map(a => ({ id: a.id, score: a.run_cycle(1, settings), budget: a.budget_req, profile: a.profile }));
            c1_data.sort((a,b) => b.score - a.score);

            let spent = 0;
            let fundedC1 = new Set();
            let cutoffC1 = 0;

            for(let a of c1_data) {
                if (spent + a.budget <= totalBudget) {
                    spent += a.budget;
                    fundedC1.add(a.id);
                    cutoffC1 = a.score;
                } else {
                    break;
                }
            }

            // Update Sys C1 Stats
            let countC1 = fundedC1.size;
            sysC1.sum += countC1;
            sysC1.min = Math.min(sysC1.min, countC1);
            sysC1.max = Math.max(sysC1.max, countC1);
            sysC1.sumCutoff += cutoffC1;
            sysC1.sumSpent += spent;

            // Update Profile Pop Count
            athletes.forEach(a => stats[a.profile].pop++);

            // --- Interim ---
            athletes.forEach(a => {
                let res = a.simulate_season();
                let tiers = res.filter(r => r.tier < 7).map(r => r.tier);
                a.cycle_1_performance_tier = tiers.length > 0 ? Math.min(...tiers) : 6;
            });

            // --- C2 ---
            let c2_data = athletes.map(a => ({ id: a.id, score: a.run_cycle(2, settings), budget: a.budget_req }));
            c2_data.sort((a,b) => b.score - a.score);

            spent = 0;
            let fundedC2 = new Set();
            let cutoffC2 = 0;

            for(let a of c2_data) {
                if (spent + a.budget <= totalBudget) {
                    spent += a.budget;
                    fundedC2.add(a.id);
                    cutoffC2 = a.score;
                } else {
                    break;
                }
            }

            // Update Sys C2 Stats
            let countC2 = fundedC2.size;
            sysC2.sum += countC2;
            sysC2.min = Math.min(sysC2.min, countC2);
            sysC2.max = Math.max(sysC2.max, countC2);
            sysC2.sumCutoff += cutoffC2;
            sysC2.sumSpent += spent;

            // --- PROFILE AGGREGATION ---
            athletes.forEach(a => {
                let p = a.profile;
                let inC1 = fundedC1.has(a.id);
                let inC2 = fundedC2.has(a.id);

                // Penalty Tracking (if C2)
                let penVal = (1.0 - a.current_penalty) > 0 ? (1.0 - a.current_penalty) : 0;
                stats[p].penaltySum += penVal;

                if (inC1) {
                    stats[p].c1++;
                    if (inC2) {
                        // Survived
                        stats[p].c2++;
                        stats[p].survived++;
                        stats[p].survCount++;
                        stats[p].survSkill += a.skill;
                        stats[p].survTier += a.cycle_1_performance_tier;
                    } else {
                        // Dropped
                        stats[p].drop++;
                        stats[p].dropCount++;
                        stats[p].dropSkill += a.skill;
                        stats[p].dropTier += a.cycle_1_performance_tier;
                    }
                } else if (inC2) {
                    stats[p].c2++; // New entrant
                }
            });
        }

        updateUI(sysC1, sysC2, stats, iterations);
    }

    function getContext(score) {
        if (score >= 26) return ">= 1x Gold";
        if (score >= 21) return ">= 1x Silver";
        if (score >= 16) return ">= 1x Bronze";
        if (score >= 12) return ">= 1x Top 8 + 1x Top 16";
        if (score >= 8)  return ">= 1x Top 8 or 2x Top 16";
        if (score >= 4)  return ">= 1x Top 16";
        return "Participation";
    }

    function updateBadge(el, spentPct) {
        el.innerText = spentPct.toFixed(1) + "% Spent";
        if (spentPct >= 99.9) {
            el.className = "px-2 py-1 text-xs font-bold rounded bg-red-100 text-red-700";
        } else {
            el.className = "px-2 py-1 text-xs font-bold rounded bg-green-100 text-green-700";
        }
    }

    function updateUI(c1, c2, stats, n) {
        // System Summary
        document.getElementById('c1_funded').innerText = (c1.sum / n).toFixed(1);
        document.getElementById('c1_range').innerText = `${c1.min} - ${c1.max}`;
        let cut1 = c1.sumCutoff / n;
        document.getElementById('c1_cutoff').innerText = cut1.toFixed(2) + " pts";
        document.getElementById('c1_context').innerText = getContext(cut1);
        updateBadge(document.getElementById('c1_budget_badge'), c1.sumSpent / n);

        document.getElementById('c2_funded').innerText = (c2.sum / n).toFixed(1);
        document.getElementById('c2_range').innerText = `${c2.min} - ${c2.max}`;
        let cut2 = c2.sumCutoff / n;
        document.getElementById('c2_cutoff').innerText = cut2.toFixed(2) + " pts";
        document.getElementById('c2_context').innerText = getContext(cut2);
        updateBadge(document.getElementById('c2_budget_badge'), c2.sumSpent / n);

        // Profile Table
        const tbody = document.getElementById('profileTableBody');
        const qbody = document.getElementById('qualityTableBody');
        tbody.innerHTML = '';
        qbody.innerHTML = '';

        const profiles = ['Gambler', 'Honest', 'Conservative'];
        
        let chartDataFunded = [];
        let chartDataSurvive = [];
        let chartDataPenalty = [];

        profiles.forEach(p => {
            let d = stats[p];
            let avgC1 = d.c1 / n;
            let avgC2 = d.c2 / n;
            let avgDrop = d.drop / n;
            let survRate = d.c1 > 0 ? (d.survived / d.c1) * 100 : 0;
            let avgPen = (d.penaltySum / d.pop) * 100;

            chartDataFunded.push({c1: avgC1, c2: avgC2});
            chartDataSurvive.push(survRate);
            chartDataPenalty.push(avgPen);

            let row = `
                <tr class="bg-white border-b hover:bg-gray-50">
                    <td class="px-6 py-4 font-medium text-gray-900">${p}</td>
                    <td class="px-6 py-4 text-right">${(d.pop/n).toFixed(1)}</td>
                    <td class="px-6 py-4 text-right text-blue-600 font-semibold">${avgC1.toFixed(1)}</td>
                    <td class="px-6 py-4 text-right text-purple-600 font-semibold">${avgC2.toFixed(1)}</td>
                    <td class="px-6 py-4 text-right text-red-500">${avgDrop.toFixed(1)}</td>
                    <td class="px-6 py-4 text-right">${survRate.toFixed(1)}%</td>
                    <td class="px-6 py-4 text-right">${avgPen.toFixed(1)}%</td>
                </tr>`;
            tbody.innerHTML += row;

            // Quality Table
            let sSkill = d.survCount > 0 ? d.survSkill / d.survCount : 0;
            let sTier = d.survCount > 0 ? d.survTier / d.survCount : 0;
            let dSkill = d.dropCount > 0 ? d.dropSkill / d.dropCount : 0;
            let dTier = d.dropCount > 0 ? d.dropTier / d.dropCount : 0;

            let qrow = `
                <tr class="bg-white border-b hover:bg-gray-50">
                    <td class="px-6 py-4 font-medium text-gray-900">${p}</td>
                    <td class="px-6 py-4 text-right">${sTier.toFixed(1)}</td>
                    <td class="px-6 py-4 text-right text-gray-400">${sSkill.toFixed(2)}</td>
                    <td class="px-6 py-4 text-right">${dTier.toFixed(1)}</td>
                    <td class="px-6 py-4 text-right text-gray-400">${dSkill.toFixed(2)}</td>
                </tr>`;
            qbody.innerHTML += qrow;
        });

        updateCharts(profiles, chartDataFunded, chartDataSurvive, chartDataPenalty);
    }

    // --- SLIDER LOGIC ---
    const sGambler = document.getElementById('pctGambler');
    const sHonest = document.getElementById('pctHonest');
    const dGambler = document.getElementById('valGambler');
    const dHonest = document.getElementById('valHonest');
    const dCons = document.getElementById('valConservative');

    function updateSliders() {
        let g = parseInt(sGambler.value);
        let h = parseInt(sHonest.value);
        
        if (g + h > 100) {
            h = 100 - g;
            sHonest.value = h;
        }
        let c = 100 - g - h;
        
        dGambler.innerText = g + '%';
        dHonest.innerText = h + '%';
        dCons.innerText = c + '%';
    }

    sGambler.addEventListener('input', updateSliders);
    sHonest.addEventListener('input', updateSliders);

    // --- CHARTS ---
    let fundingChart = null;
    let survivalChart = null;

    function updateCharts(labels, fundedData, surviveData, penaltyData) {
        // Funding Chart
        const ctx1 = document.getElementById('fundingChart').getContext('2d');
        if(fundingChart) fundingChart.destroy();
        fundingChart = new Chart(ctx1, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Funded C1', data: fundedData.map(d => d.c1), backgroundColor: '#3b82f6' },
                    { label: 'Funded C2', data: fundedData.map(d => d.c2), backgroundColor: '#a855f7' }
                ]
            },
            options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });

        // Survival Chart (Mixed Bar/Line)
        const ctx2 = document.getElementById('survivalChart').getContext('2d');
        if(survivalChart) survivalChart.destroy();
        survivalChart = new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Survival Rate %', data: surviveData, backgroundColor: '#22c55e', yAxisID: 'y' },
                    { label: 'Avg Penalty %', data: penaltyData, backgroundColor: '#ef4444', yAxisID: 'y1' }
                ]
            },
            options: { 
                responsive: true,
                scales: {
                    y: { beginAtZero: true, max: 100, position: 'left' },
                    y1: { beginAtZero: true, max: 50, position: 'right', grid: { drawOnChartArea: false } }
                }
            }
        });
    }

    // Init
    updateSliders();
    // Auto-run once on load
    runSimulation();

</script>
</body>
</html>
